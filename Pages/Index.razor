@page "/"
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject UserState UserState

<h1>üìä Dashboard</h1>

<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5>üí≥ Total Expenses</h5>
                <h2>$@totalExpenses.ToString("N2")</h2>
                <small>This month</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5>üìä Budget</h5>
                <h2>$@monthlyBudget.ToString("N2")</h2>
                <small>Monthly limit</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5>üí∞ Remaining</h5>
                <h2>$@remainingBudget.ToString("N2")</h2>
                @* <small>@((int)((1 - (totalExpenses / monthlyBudget)) * 100))% left</small> *@
                @if (monthlyBudget > 0)
                {
                    <small>@PercentageLeft% left</small>
                }
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5>üìÅ Categories</h5>
                <h2>@categoryCount</h2>
                <small>Active categories</small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5>Recent Expenses</h5>

                @if (recentExpenses.Any())
                {
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var expense in recentExpenses)
                            {
                                <tr>
                                    <td>@expense.Date.ToString("MMM dd")</td>
                                    <td>@expense.Description</td>
                                    <td>
                                        @(expense.Category?.Icon ?? "")
                                        @(expense.Category?.Name ?? "Uncategorized")
                                    </td>
                                    <td>$@expense.Amount.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>No expenses yet.</p>
                }

                <a href="/expenses" class="btn btn-primary">View All</a>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5>Quick Actions</h5>
                <div class="d-grid gap-2">
                    <a href="/expenses/create" class="btn btn-success">‚ûï Add Expense</a>
                    <a href="/categories/create" class="btn btn-info">üìÅ New Category</a>
                    <a href="/budgets/create" class="btn btn-warning">üìä Set Budget</a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private decimal totalExpenses;
    private decimal monthlyBudget;
    private decimal remainingBudget => monthlyBudget - totalExpenses;
    private int categoryCount;
    private List<Expense> recentExpenses = new();
    private int PercentageLeft => monthlyBudget > 0 ? (int)((1 - (totalExpenses / monthlyBudget)) * 100) : 0;

    protected override async Task OnInitializedAsync()
    {
        var startOfMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);

        totalExpenses = await DbContext.Expenses
        .Where(e => e.UserId == UserState.CurrentUserId && e.Date >= startOfMonth)
        .SumAsync(e => e.Amount);

        var budget = await DbContext.Budgets
        .FirstOrDefaultAsync(b =>
        b.UserId == UserState.CurrentUserId &&
        b.Month == DateTime.Today.Month &&
        b.Year == DateTime.Today.Year);

        monthlyBudget = budget?.Amount ?? 0m;

        remaining = monthlyBudget - totalExpenses;

        // Safe percent calculation (no divide by zero)
        if (monthlyBudget > 0m)
        {
            var ratioLeft = 1m - (totalExpenses / monthlyBudget);
            percentLeft = (int)Math.Round(ratioLeft * 100m);

            // clamp to a sensible range
            if (percentLeft < 0) percentLeft = 0;
            if (percentLeft > 100) percentLeft = 100;
        }
        else
        {
            percentLeft = 0;
        }

        categoryCount = await DbContext.Categories
        .Where(c => c.UserId == UserState.CurrentUserId)
        .CountAsync();

        recentExpenses = await DbContext.Expenses
        .Include(e => e.Category)
        .Where(e => e.UserId == UserState.CurrentUserId)
        .OrderByDescending(e => e.Date)
        .Take(5)
        .ToListAsync();
    }
}