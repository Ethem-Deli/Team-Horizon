@page "/expenses/edit/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using FamilyBudgetExpenseTracker.Data
@using FamilyBudgetExpenseTracker.Models

@inject ApplicationDbContext DbContext
@inject NavigationManager NavManager
@inject UserState UserState

<h1>✏️ Edit Expense</h1>

@if (loading)
{
    <p><em>Loading...</em></p>
}
else if (expense == null)
{
    <div class="alert alert-warning">
        Expense not found (or you don’t have permission to edit it).
    </div>
    <a href="/expenses" class="btn btn-secondary">Back</a>
}
else
{
    @if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger">@error</div>
    }

    <form @onsubmit="OnSubmit" @onsubmit:preventDefault="true">
        <div class="mb-3">
            <label class="form-label">Amount:</label>
            <input type="number" step="0.01" class="form-control" @bind="expense.Amount" />
        </div>

        <div class="mb-3">
            <label class="form-label">Date:</label>
            <input type="date" class="form-control" @bind="expense.Date" />
        </div>

        <div class="mb-3">
            <label class="form-label">Description:</label>
            <input class="form-control" @bind="expense.Description" />
        </div>

        <div class="mb-3">
            <label class="form-label">Category:</label>
            <select class="form-control" @bind="expense.CategoryId">
                <option value="0">Select category...</option>
                @foreach (var category in categories)
                {
                    <option value="@category.Id">@category.Icon @category.Name</option>
                }
            </select>
        </div>

        <div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="/expenses" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
}

@code {
    [Parameter] public int Id { get; set; }

    private Expense? expense;
    private List<Category> categories = new();
    private bool loading = true;
    private string? error;

    // HTML <input type="date"> binds to string in yyyy-MM-dd format
    private string dateString = "";

    protected override async Task OnInitializedAsync()
    {

        // Only allow editing current user's expense
        expense = await DbContext.Expenses
        .FirstOrDefaultAsync(e => e.Id == Id && e.UserId == UserState.CurrentUserId);

        if (expense != null)
        {
            // Load current user's categories
            categories = await DbContext.Categories
            .Where(c => c.UserId == UserState.CurrentUserId)
            .OrderBy(c => c.Name)
            .ToListAsync();

            dateString = expense.Date.ToString("yyyy-MM-dd");
        }

        loading = false;
    }

    private async Task OnSubmit()
    {
        if (expense == null)
        {
            NavManager.NavigateTo("/expenses");
            return;
        }

        // Basic validation (since we are not using DataAnnotationsValidator)
        if (expense.Amount <= 0)
        {
            error = "Amount must be greater than 0.";
            return;
        }

        if (string.IsNullOrWhiteSpace(expense.Description))
        {
            error = "Description is required.";
            return;
        }

        if (expense.CategoryId <= 0)
        {
            error = "Please select a category.";
            return;
        }

        if (!DateTime.TryParse(dateString, out var parsedDate))
        {
            error = "Please enter a valid date.";
            return;
        }

        expense.Date = parsedDate;

        // Safety check: still the current user's expense
        if (expense.UserId != UserState.CurrentUserId)
        {
            NavManager.NavigateTo("/expenses");
            return;
        }

        error = null;
        await DbContext.SaveChangesAsync();
        NavManager.NavigateTo("/expenses");
    }
}