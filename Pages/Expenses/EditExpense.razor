@page "/expenses/edit/{Id:int}"

@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using FamilyBudgetExpenseTracker.Data
@using FamilyBudgetExpenseTracker.Models

@inject ApplicationDbContext DbContext
@inject NavigationManager NavManager
@inject UserState UserState

<h1>✏️ Edit Expense</h1>

@if (loading)
{
    <p><em>Loading...</em></p>
}
else if (expense == null)
{
    <div class="alert alert-warning">
        Expense not found (or you don’t have permission to edit it).
    </div>
    <a href="/expenses" class="btn btn-secondary">Back</a>
}
else
{
    @if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger">@error</div>
    }

    <EditForm Model="expense" OnValidSubmit="OnSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger small" />

        <div class="mb-3">
            <label class="form-label">Amount:</label>
            <InputNumber @bind-Value="expense.Amount" step="0.01" class="form-control" />
            <ValidationMessage For="@(() => expense.Amount)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Date:</label>
            <InputDate @bind-Value="expense.Date" class="form-control" />
            <ValidationMessage For="@(() => expense.Date)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Description:</label>
            <InputText @bind-Value="expense.Description" class="form-control" />
            <ValidationMessage For="@(() => expense.Description)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Category:</label>
            <InputSelect @bind-Value="expense.CategoryId" class="form-control">
                <option value="0">Select category...</option>
                @foreach (var category in categories)
                {
                    <option value="@category.Id">@category.Icon @category.Name</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => expense.CategoryId)" />
        </div>

        <div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="/expenses" class="btn btn-secondary">Cancel</a>
        </div>
    </EditForm>
}

@code {
    [Parameter] public int Id { get; set; }

    private Expense? expense;
    private List<Category> categories = new();
    private bool loading = true;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        expense = await DbContext.Expenses
            .FirstOrDefaultAsync(e => e.Id == Id && e.UserId == UserState.CurrentUserId);

        if (expense != null)
        {
            categories = await DbContext.Categories
                .Where(c => c.UserId == UserState.CurrentUserId)
                .OrderBy(c => c.Name)
                .ToListAsync();
        }

        loading = false;
    }

    private async Task OnSubmit()
    {
        if (expense == null)
        {
            NavManager.NavigateTo("/expenses");
            return;
        }

        if (expense.UserId != UserState.CurrentUserId)
        {
            NavManager.NavigateTo("/expenses");
            return;
        }

        error = null;
        await DbContext.SaveChangesAsync();
        NavManager.NavigateTo("/expenses");
    }
}
