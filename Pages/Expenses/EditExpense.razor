@page "/expenses/edit/{Id:int}"

@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using FamilyBudgetExpenseTracker.Data
@using FamilyBudgetExpenseTracker.Models
@using FamilyBudgetExpenseTracker.Services

@inject ApplicationDbContext DbContext
@inject NavigationManager NavManager
@inject UserState UserState

<h1>✏️ Edit Expense</h1>

@if (loading)
{
    <p><em>Loading...</em></p>
}
else if (expense == null)
{
    <div class="alert alert-warning">
        Expense not found (or you don’t have permission to edit it).
    </div>
    <a href="/expenses" class="btn btn-secondary">Back</a>
}
else
{
    @if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger">@error</div>
    }

    <!-- Use EditForm + Input components to avoid Date/Time conversion issues -->
    <EditForm Model="expense" OnValidSubmit="OnSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger small" />

        <div class="mb-3">
            <label class="form-label">Amount:</label>
            <InputNumber @bind-Value="expense.Amount" class="form-control" />
            <ValidationMessage For="@(() => expense.Amount)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Date:</label>
            <!--  Expense.Date is DateTime, so bind using InputDate -->
            <InputDate @bind-Value="expense.Date" class="form-control" />
            <ValidationMessage For="@(() => expense.Date)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Description:</label>
            <InputText @bind-Value="expense.Description" class="form-control" />
            <ValidationMessage For="@(() => expense.Description)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Category:</label>
            <InputSelect @bind-Value="expense.CategoryId" class="form-control">
                <option value="0">Select category...</option>
                @foreach (var category in categories)
                {
                    <option value="@category.Id">@category.Icon @category.Name</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => expense.CategoryId)" />
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" disabled="@saving">
                @(saving ? "Saving..." : "Save Changes")
            </button>
            <a href="/expenses" class="btn btn-secondary">Cancel</a>
        </div>
    </EditForm>
}

@code {
    [Parameter] public int Id { get; set; }

    private Expense? expense;
    private List<Category> categories = new();
    private bool loading = true;
    private bool saving = false;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        error = null;

        // SECURITY: Must be logged in to edit expenses.
        if (UserState.CurrentUserId <= 0)
        {
            NavManager.NavigateTo("/account/login");
            return;
        }

        try
        {
            // SECURITY: Load ONLY the current user's expense (Id + UserId).
            expense = await DbContext.Expenses
                .FirstOrDefaultAsync(e => e.Id == Id && e.UserId == UserState.CurrentUserId);

            if (expense != null)
            {
                // SECURITY: Load ONLY the current user's categories.
                categories = await DbContext.Categories
                    .AsNoTracking()
                    .Where(c => c.UserId == UserState.CurrentUserId)
                    .OrderBy(c => c.Name)
                    .ToListAsync();
            }
        }
        catch
        {
            error = "Could not load expense. Please try again.";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task OnSubmit()
    {
        if (saving || expense == null) return;

        // SECURITY: Prevent cross-user update (ownership check).
        if (expense.UserId != UserState.CurrentUserId)
        {
            NavManager.NavigateTo("/expenses");
            return;
        }

        // Defense-in-depth cleanup (DataAnnotations already validated the model)
        expense.Amount = decimal.Round(expense.Amount, 2);
        expense.Description = (expense.Description ?? string.Empty).Trim();

        saving = true;
        error = null;

        try
        {
            // SECURITY: Ensure selected category belongs to current user.
            var categoryOwnedByUser = await DbContext.Categories
                .AsNoTracking()
                .AnyAsync(c => c.Id == expense.CategoryId && c.UserId == UserState.CurrentUserId);

            if (!categoryOwnedByUser)
            {
                error = "Invalid category selection.";
                return;
            }

            await DbContext.SaveChangesAsync();
            NavManager.NavigateTo("/expenses");
        }
        catch
        {
            error = "Could not save changes. Please try again.";
        }
        finally
        {
            saving = false;
        }
    }
}