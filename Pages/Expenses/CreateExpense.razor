@page "/expenses/create"

@using Microsoft.EntityFrameworkCore
@using FamilyBudgetExpenseTracker.Data
@using FamilyBudgetExpenseTracker.Models

@inject ApplicationDbContext DbContext
@inject UserState UserState
@inject NavigationManager Navigation

<h1>âž• Add New Expense</h1>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}

<form @onsubmit="OnSubmit" @onsubmit:preventDefault="true">
    <div class="mb-3">
        <label class="form-label">Amount:</label>
        <input type="number" step="0.01" class="form-control" @bind="expense.Amount" />
    </div>

    <div class="mb-3">
        <label class="form-label">Date:</label>
        <input type="date" class="form-control" @bind="expense.Date" />
    </div>

    <div class="mb-3">
        <label class="form-label">Description:</label>
        <input class="form-control" @bind="expense.Description" />
    </div>

    <div class="mb-3">
        <label class="form-label">Category:</label>
        <select class="form-control" @bind="expense.CategoryId">
            <option value="0">Select a category...</option>
            @foreach (var category in categories)
            {
                <option value="@category.Id">@category.Icon @category.Name</option>
            }
        </select>
    </div>

    <div>
        <button type="submit" class="btn btn-primary">Save</button>
        <a href="/expenses" class="btn btn-secondary">Cancel</a>
    </div>
</form>

@code {
    private Expense expense = new Expense();
    private List<Category> categories = new();
    private string? error;

    // HTML date input uses yyyy-MM-dd format
    private string dateString = DateTime.Today.ToString("yyyy-MM-dd");

    protected override async Task OnInitializedAsync()
    {
        expense.Date = DateTime.Today;

        categories = await DbContext.Categories
        .Where(c => c.UserId == UserState.CurrentUserId)
        .OrderBy(c => c.Name)
        .ToListAsync();
    }

    private async Task OnSubmit()
    {
        // Manual validation (since we are not using EditForm/DataAnnotationsValidator)
        if (expense.Amount <= 0)
        {
            error = "Amount must be greater than 0.";
            return;
        }

        if (string.IsNullOrWhiteSpace(expense.Description))
        {
            error = "Description is required.";
            return;
        }

        if (expense.CategoryId <= 0)
        {
            error = "Please select a category.";
            return;
        }

        if (!DateTime.TryParse(dateString, out var parsedDate))
        {
            error = "Please enter a valid date.";
            return;
        }

        expense.Date = parsedDate;
        expense.UserId = UserState.CurrentUserId;

        error = null;

        DbContext.Expenses.Add(expense);
        await DbContext.SaveChangesAsync();
        Navigation.NavigateTo("/expenses");
    }
}