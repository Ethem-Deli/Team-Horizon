@page "/budgets/edit/{Id:int}"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using FamilyBudgetExpenseTracker.Data
@using FamilyBudgetExpenseTracker.Models
@using FamilyBudgetExpenseTracker.Services

@attribute [Authorize]

@inject ApplicationDbContext DbContext
@inject IBudgetService BudgetService
@inject UserState UserState
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Edit Budget</PageTitle>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-7 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body p-4">

                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h3 class="card-title mb-0">‚úèÔ∏è Edit Budget</h3>
                        <a class="btn btn-outline-secondary btn-sm" href="/budgets">Back</a>
                    </div>

                    @if (isLoading)
                    {
                        <p><em>Loading...</em></p>
                    }
                    else if (notFound)
                    {
                        <div class="alert alert-warning">
                            Budget not found (or you don‚Äôt have access).
                        </div>
                        <a class="btn btn-primary" href="/budgets">Go to Budgets</a>
                    }
                    else
                    {
                        <EditForm Model="@budget" OnValidSubmit="HandleSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger small" />

                            <div class="mb-3">
                                <label class="form-label">Month</label>
                                <InputSelect @bind-Value="budget!.Month" class="form-control" disabled="@isSaving">
                                    @for (int i = 1; i <= 12; i++)
                                    {
                                        <option value="@i">@(new DateTime(2000, i, 1).ToString("MMMM"))</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Year</label>
                                <InputNumber @bind-Value="budget!.Year" class="form-control" disabled="@isSaving" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Budget Amount ($)</label>
                                <InputNumber @bind-Value="budget!.Amount" class="form-control" placeholder="0.00"
                                             disabled="@isSaving" />
                                <ValidationMessage For="@(() => budget!.Amount)" />
                            </div>

                            @if (!string.IsNullOrWhiteSpace(errorMessage))
                            {
                                <div class="alert alert-danger">@errorMessage</div>
                            }

                            @if (!string.IsNullOrWhiteSpace(successMessage))
                            {
                                <div class="alert alert-success">@successMessage</div>
                            }

                            <div class="d-flex gap-2 pt-2">
                                <button type="submit" class="btn btn-primary px-4" disabled="@isSaving">
                                    @(isSaving ? "Saving..." : "Save Changes")
                                </button>

                                <button type="button" class="btn btn-outline-danger ms-auto" disabled="@isSaving"
                                        @onclick="ConfirmDelete">
                                    üóë Delete
                                </button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private Budget? budget;
    private bool isLoading = true;
    private bool notFound = false;
    private bool isSaving = false;

    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        // SECURITY: Must be logged in (and have a valid user id) to load any data.
        if (UserState.CurrentUserId <= 0)
        {
            Navigation.NavigateTo("/account/login");
            return;
        }

        try
        {
            // SECURITY: Load ONLY a budget that belongs to the current user (Id + UserId).
            budget = await DbContext.Budgets
                .AsTracking()
                .FirstOrDefaultAsync(b => b.Id == Id && b.UserId == UserState.CurrentUserId);

            if (budget == null)
            {
                notFound = true;
            }
        }
        catch
        {
            // Friendly error: do not expose exception/DB details.
            notFound = true;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        if (isSaving || budget == null) return;

        // SECURITY: Prevent cross-user updates if something was tampered.
        if (budget.UserId != UserState.CurrentUserId)
        {
            Navigation.NavigateTo("/budgets", forceLoad: true);
            return;
        }

        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            // Important logic:
            // Prevent duplicate budgets if the user changes Month/Year to an existing period.
            // SECURITY: duplicate check must also be scoped to the current user.
            var duplicate = await DbContext.Budgets
                .AsNoTracking()
                .FirstOrDefaultAsync(b =>
                    b.UserId == UserState.CurrentUserId &&
                    b.Month == budget.Month &&
                    b.Year == budget.Year &&
                    b.Id != budget.Id);

            if (duplicate != null)
            {
                errorMessage = "A budget already exists for that month and year. Please choose a different period.";
                return;
            }

            // SECURITY: Ensure ownership is correct and cannot be overwritten.
            budget.UserId = UserState.CurrentUserId;

            // Save via service (service contains user isolation rules too).
            var ok = await BudgetService.UpsertBudgetAsync(budget);
            if (!ok)
            {
                errorMessage = "Could not update budget. Please try again.";
                return;
            }

            successMessage = "Budget updated successfully.";
            Navigation.NavigateTo("/budgets", forceLoad: true);
        }
        catch
        {
            // Friendly error: no sensitive information shown.
            errorMessage = "Could not update budget. Please check the fields and try again.";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ConfirmDelete()
    {
        if (budget == null || isSaving) return;

        // SECURITY: Ensure user still owns this budget before deleting.
        if (budget.UserId != UserState.CurrentUserId)
        {
            Navigation.NavigateTo("/budgets", forceLoad: true);
            return;
        }

        // Important logic: confirm destructive action with the user.
        var period = $"{new DateTime(2000, budget.Month, 1):MMMM} {budget.Year}";
        var ok = await JS.InvokeAsync<bool>("confirm", $"Delete the budget for {period}? This cannot be undone.");

        if (!ok) return;

        isSaving = true;
        errorMessage = null;

        try
        {
            // SECURITY: Delete only if (BudgetId + UserId) matches.
            var deleted = await BudgetService.DeleteBudgetAsync(budget.Id, UserState.CurrentUserId);
            if (!deleted)
            {
                errorMessage = "Could not delete budget (not found or access denied).";
                return;
            }

            Navigation.NavigateTo("/budgets", forceLoad: true);
        }
        catch
        {
            // Friendly error message
            errorMessage = "Could not delete budget. Please try again.";
        }
        finally
        {
            isSaving = false;
        }
    }
}