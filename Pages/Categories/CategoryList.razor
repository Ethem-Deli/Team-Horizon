@page "/categories"
@using Microsoft.EntityFrameworkCore;
@inject ApplicationDbContext DbContext
@inject UserState UserState
@inject ICategoryService CategoryService
@inject NavigationManager Navigation

<PageTitle>Categories</PageTitle>

<h1>üìÅ Categories</h1>

<div class="mb-3">
    <a href="/categories/create" class="btn btn-primary">‚ûï Add New Category</a>
</div>

@if (categories == null)
{
    <p><em>Loading...</em></p>
}
else if (!categories.Any())
{
    <p>No categories found. <a href="/categories/create">Create your first category</a></p>
}
else
{
    <div class="row">
        @foreach (var category in categories)
        {
            <div class="col-md-4 mb-3">
                <div class="card" style="border-left: 4px solid @category.ColorCode">
                    <div class="card-body">
                        <h5>@category.Icon @category.Name</h5>
                        <p class="text-muted">@category.Description</p>
                        <div>
                            <a href="/categories/edit/@category.Id" class="btn btn-sm btn-warning">Edit</a>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteCategory(category.Id)">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Category>? categories;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        if (UserState.CurrentUserId == 0)
        {
            categories = new List<Category>();
            return;
        }
        categories = await CategoryService.GetUserCategoriesAsync(UserState.CurrentUserId);
        @* categories = await DbContext.Categories
        .Where(c => c.UserId == UserState.CurrentUserId)
        .ToListAsync(); *@
    }
    private async Task DeleteCategory(int id)
    {
        if (UserState.CurrentUserId == 0)
        {
            return;
        }
        await CategoryService.DeleteCategoryAsync(id, UserState.CurrentUserId);
        await LoadCategories();
    }
    @* var category = await DbContext.Categories.FindAsync(id);
        if (category != null)
        {
            DbContext.Categories.Remove(category);
            await DbContext.SaveChangesAsync();
            await LoadCategories();
        } *@
}
}