@page "/categories"

@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using FamilyBudgetExpenseTracker.Models
@using FamilyBudgetExpenseTracker.Services

@inject UserState UserState
@inject ICategoryService CategoryService
@inject NavigationManager Navigation

<PageTitle>Categories</PageTitle>

<h1>üìÅ Categories</h1>

<div class="mb-3">
    <a href="/categories/create" class="btn btn-primary">‚ûï Add New Category</a>
</div>

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (categories == null)
{
    <p><em>Loading...</em></p>
}
else if (!categories.Any())
{
    <p>No categories found. <a href="/categories/create">Create your first category</a></p>
}
else
{
    <div class="row">
        @foreach (var category in categories)
        {
            <div class="col-md-4 mb-3">
                <div class="card" style="border-left: 4px solid @category.ColorCode">
                    <div class="card-body">
                        <h5>@category.Icon @category.Name</h5>
                        <p class="text-muted">@category.Description</p>
                        <div>
                            <a href="/categories/edit/@category.Id" class="btn btn-sm btn-warning">Edit</a>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteCategory(category.Id)">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Category>? categories;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        // SECURITY: Must be logged in to view categories.
        if (UserState.CurrentUserId <= 0)
        {
            Navigation.NavigateTo("/account/login");
            return;
        }

        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        errorMessage = null;

        try
        {
            // SECURITY: CategoryService enforces user isolation (filters by UserId).
            categories = await CategoryService.GetUserCategoriesAsync(UserState.CurrentUserId);
        }
        catch
        {
            // Friendly error; no sensitive details shown.
            errorMessage = "Could not load categories. Please refresh and try again.";
            categories = new List<Category>();
        }
    }

    private async Task DeleteCategory(int id)
    {
        errorMessage = null;

        // SECURITY: Must be logged in to delete.
        if (UserState.CurrentUserId <= 0)
        {
            Navigation.NavigateTo("/account/login");
            return;
        }

        try
        {
            // SECURITY: Service method deletes only if (CategoryId + UserId) matches.
            await CategoryService.DeleteCategoryAsync(id, UserState.CurrentUserId);
            await LoadCategories();
        }
        catch
        {
            errorMessage = "Could not delete category. Please try again.";
        }
    }
}