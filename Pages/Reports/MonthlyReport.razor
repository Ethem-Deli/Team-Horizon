@page "/reports/monthly"

@using Microsoft.JSInterop
@using FamilyBudgetExpenseTracker.Models.ViewModels
@using FamilyBudgetExpenseTracker.Services

@inject IJSRuntime JS
@inject MonthlyReportService ReportService
@inject UserState UserState

<PageTitle>Monthly Report - @(new DateTime(selectedYear, selectedMonth, 1).ToString("MMMM yyyy"))</PageTitle>

<div class="container py-4">
    <h2 class="mb-3">ðŸ“ˆ Monthly Report</h2>

    <div class="row mb-4 bg-light p-3 rounded">
        <div class="col-md-3">
            <label class="form-label">Month</label>
            <select @bind="selectedMonth" class="form-select">
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i">@(new DateTime(2000, i, 1).ToString("MMMM"))</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Year</label>
            <select @bind="selectedYear" class="form-select">
                @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 5; year--)
                {
                    <option value="@year">@year</option>
                }
            </select>
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button @onclick="LoadReport" class="btn btn-primary w-100" disabled="@loading">
                @if (loading)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    <span>Loading...</span>
                }
                else
                {
                    <i class="bi bi-search"></i> <span>Load Report</span>
                }
            </button>
        </div>
    </div>

    @if (report == null)
    {
        <div class="text-center py-5">
            <p class="text-muted">Select a period and click Load Report to analyze your spending.</p>
        </div>
    }
    else if (!report.Expenses.Any())
    {
        <div class="alert alert-info">
            No expenses found for <strong>@report.MonthName @report.Year</strong>.
        </div>
    }
    else
    {
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card border-primary h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Monthly Budget</h6>
                        <h3 class="text-primary">$@report.TotalBudget.ToString("N2")</h3>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card border-danger h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Total Spent</h6>
                        <h3 class="text-danger">$@report.TotalExpenses.ToString("N2")</h3>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card @(report.IsOverBudget ? "border-warning" : "border-success") h-100">
                    <div class="card-body text-center">
                        <h6 class="text-muted">@(report.RemainingBalance < 0 ? "Over Budget" : "Remaining")</h6>
                        <h3 class="@(report.RemainingBalance < 0 ? "text-warning" : "text-success")">
                            $@Math.Abs(report.RemainingBalance).ToString("N2")
                        </h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <div class="d-flex justify-content-between mb-1">
                <span>Budget Usage</span>
                <span>@report.PercentageUsed.ToString("N1")%</span>
            </div>

            <div class="progress" style="height: 25px;">
                <div class="progress-bar @(report.PercentageUsed > 100 ? "bg-danger" : report.PercentageUsed > 80 ? "bg-warning" : "bg-success")"
                     role="progressbar"
                     style="width: @(Math.Min(report.PercentageUsed, 100))%;"></div>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-12 col-lg-7">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Daily Spending (Bar)</h5>
                        <div class="chart-container">
                            <canvas id="monthlyDailyBarChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-5">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Spending by Category (Pie)</h5>
                        <div class="chart-container">
                            <canvas id="monthlyCategoryPieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-5 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Spending by Category</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th class="text-end">Amount</th>
                                        <th class="text-end">%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var cat in report.CategorySummaries)
                                    {
                                        <tr>
                                            <td>@cat.CategoryName <small class="text-muted">(@cat.TransactionCount)</small></td>
                                            <td class="text-end">$@cat.TotalSpent.ToString("N2")</td>
                                            <td class="text-end">@cat.PercentageOfTotalSpending.ToString("N0")%</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Transactions</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var expense in report.Expenses)
                                    {
                                        <tr>
                                            <td>@expense.Date.ToString("MMM dd")</td>
                                            <td>
                                                <div class="fw-bold">@expense.Description</div>
                                                <small class="text-muted">@expense.Category?.Name</small>
                                            </td>
                                            <td class="text-end fw-bold">$@expense.Amount.ToString("N2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private int selectedMonth = DateTime.Today.Month;
    private int selectedYear = DateTime.Today.Year;

    private bool loading;
    private MonthlyReportViewModel? report;

    private bool _pendingChartRender;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        loading = true;

        report = await ReportService.GetMonthlyReportAsync(
            UserState.CurrentUserId,
            selectedYear,
            selectedMonth
        );

        loading = false;

        if (report != null && report.Expenses.Any())
        {
            _pendingChartRender = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_pendingChartRender) return;
        _pendingChartRender = false;

        await RenderChartsAsync();
    }

    private async Task RenderChartsAsync()
    {
        if (report == null || report.Expenses == null || report.Expenses.Count == 0)
            return;

        // Daily bar chart
        var daily = report.Expenses
            .GroupBy(e => e.Date.Date)
            .OrderBy(g => g.Key)
            .Select(g => new { Day = g.Key.ToString("dd MMM"), Total = g.Sum(x => x.Amount) })
            .ToList();

        var dayLabels = daily.Select(x => x.Day).ToList();
        var dayValues = daily.Select(x => Convert.ToDouble(decimal.Round(x.Total, 2))).ToList();

        await JS.InvokeVoidAsync("budgetCharts.renderBar", "monthlyDailyBarChart", dayLabels, dayValues);

        // Category pie chart
        var cats = report.CategorySummaries
            .Where(x => x.TotalSpent > 0)
            .OrderByDescending(x => x.TotalSpent)
            .ToList();

        if (cats.Count == 0) return;

        var catLabels = cats.Select(x => x.CategoryName).ToList();
        var catValues = cats.Select(x => Convert.ToDouble(decimal.Round(x.TotalSpent, 2))).ToList();

        await JS.InvokeVoidAsync("budgetCharts.renderPie", "monthlyCategoryPieChart", catLabels, catValues);
    }
}
