@page "/reports/monthly"
@using Microsoft.EntityFrameworkCore;
@inject ApplicationDbContext DbContext
@inject UserState UserState

<PageTitle>Monthly Report</PageTitle>

<h1>ðŸ“ˆ Monthly Report</h1>

<div class="row mb-3">
    <div class="col-md-3">
        <select @bind="selectedMonth" class="form-control">
            @for (int i = 1; i <= 12; i++)
            {
                <option value="@i">@(new DateTime(2000, i, 1).ToString("MMMM"))</option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <select @bind="selectedYear" class="form-control">
            @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 5; year--)
            {
                <option value="@year">@year</option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <button @onclick="LoadReport" class="btn btn-primary">Load Report</button>
    </div>
</div>

@if (expenses == null)
{
    <p><em>Select a month and click Load Report</em></p>
}
else if (!expenses.Any())
{
    <p>No expenses for this period.</p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5>Summary</h5>
                    <p>Total Expenses: <strong>$@expenses.Sum(e => e.Amount).ToString("N2")</strong></p>
                    <p>Number of Transactions: <strong>@expenses.Count</strong></p>
                    <p>Average per Transaction: <strong>$@(expenses.Sum(e => e.Amount) /
                                                    expenses.Count).ToString("N2")</strong></p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h5>All Expenses</h5>
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var expense in expenses)
                {
                    <tr>
                        <td>@expense.Date.ToString("MMM dd")</td>
                        <td>@expense.Description</td>
                        <td>@expense.Category.Icon @expense.Category.Name</td>
                        <td>$@expense.Amount.ToString("N2")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private int selectedMonth = DateTime.Today.Month;
    private int selectedYear = DateTime.Today.Year;
    private List<Expense>? expenses;

    private async Task LoadReport()
    {
        var startDate = new DateTime(selectedYear, selectedMonth, 1);
        var endDate = startDate.AddMonths(1);

        expenses = await DbContext.Expenses
        .Include(e => e.Category)
        .Where(e => e.UserId == UserState.CurrentUserId
        && e.Date >= startDate
        && e.Date < endDate)
        .OrderByDescending(e => e.Date)
        .ToListAsync();
    }
}