@page "/reports/monthly"
@using FamilyBudgetExpenseTracker.Models.ViewModels
@using FamilyBudgetExpenseTracker.Services
@inject MonthlyReportService ReportService
@inject UserState UserState
@inject IJSRuntime JS
@using Microsoft.JSInterop
@inject IJSRuntime JS

<PageTitle>Monthly Report - @(new DateTime(selectedYear, selectedMonth, 1).ToString("MMMM yyyy"))</PageTitle>

<h1>Monthly Report</h1>

<div class="row mb-4 bg-light p-3 rounded">
    <div class="col-md-3">
        <label class="form-label">Month</label>
        <select @bind="selectedMonth" class="form-control">
            @for (int i = 1; i <= 12; i++)
            {
                <option value="@i">@(new DateTime(2000, i, 1).ToString("MMMM"))</option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">Year</label>
        <select @bind="selectedYear" class="form-control">
            @for (int year = DateTime.Today.Year; year >= DateTime.Today.Year - 5; year--)
            {
                <option value="@year">@year</option>
            }
        </select>
    </div>

    <div class="col-md-3 d-flex align-items-end">
        <button @onclick="LoadReport" class="btn btn-primary w-100">
            <i class="bi bi-search"></i> Load Report
        </button>
    </div>
</div>

@if (report == null)
{
    <div class="text-center py-5">
        <p class="text-muted">Select a period and click Load Report to analyze your spending.</p>
    </div>
}
else if (!report.Expenses.Any())
{
    <div class="alert alert-info">
        No expenses found for <strong>@report.MonthName @report.Year</strong>.
    </div>
}
else
{
    <!-- Top Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card border-primary h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Monthly Budget</h6>
                    <h3 class="text-primary">$@report.TotalBudget.ToString("N2")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-danger h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Total Spent</h6>
                    <h3 class="text-danger">$@report.TotalExpenses.ToString("N2")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card @(report.IsOverBudget ? "border-warning" : "border-success") h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">@(report.RemainingBalance < 0 ? "Over Budget" : "Remaining")</h6>
                    <h3 class="@(report.RemainingBalance < 0 ? "text-warning" : "text-success")">
                        $@Math.Abs(report.RemainingBalance).ToString("N2")
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Visual Progress Bar -->
    <div class="mb-5">
        <div class="d-flex justify-content-between mb-1">
            <span>Budget Usage</span>
            <span>@report.PercentageUsed.ToString("N1")%</span>
        </div>
        <div class="progress" style="height: 25px;">
            <div class="progress-bar @(report.PercentageUsed > 100 ? "bg-danger" : report.PercentageUsed > 80 ? "bg-warning" : "bg-success")"
                role="progressbar" style="width: @(Math.Min(report.PercentageUsed, 100))%;">
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Category Split</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthly-category-pie" height="220"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Category Totals</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthly-category-bar" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Category Breakdown -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Spending by Category</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cat in report.CategorySummaries)
                            {
                                <tr>
                                    <td>@cat.CategoryName <small class="text-muted">(@cat.TransactionCount)</small></td>
                                    <td class="text-end">$@cat.TotalSpent.ToString("N2")</td>
                                    <td class="text-end">@cat.PercentageOfTotalSpending.ToString("N0")%</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detailed Transaction List -->
        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Transactions</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var expense in report.Expenses)
                                {
                                    <tr>
                                        <td>@expense.Date.ToString("MMM dd")</td>
                                        <td>
                                            <div class="fw-bold">@expense.Description</div>
                                            <small class="text-muted">@expense.Category?.Name</small>
                                        </td>
                                        <td class="text-end fw-bold">$@expense.Amount.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private int selectedMonth = DateTime.Today.Month;
    private int selectedYear = DateTime.Today.Year;
    private MonthlyReportViewModel? report;
    private bool shouldRenderCharts;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (report == null || report.CategorySummaries.Count == 0)
        {
            return;
        }

        if (!shouldRenderCharts)
        {
            return;
        }

        shouldRenderCharts = false;

        var labels = report.CategorySummaries.Select(c => c.CategoryName).ToArray();
        var values = report.CategorySummaries.Select(c => (double)c.TotalSpent).ToArray();
        var colors = BuildColors(labels.Length);

        await JS.InvokeVoidAsync("reportsCharts.renderMonthly", labels, values, colors);
    }

    private async Task LoadReport()
    {
        report = await ReportService.GetMonthlyReportAsync(
        UserState.CurrentUserId,
        selectedYear,
        selectedMonth
        );

        shouldRenderCharts = true;
        await InvokeAsync(StateHasChanged);
    }

    private static string[] BuildColors(int count)
    {
        var palette = new[]
        {
            "#2563eb",
            "#10b981",
            "#f59e0b",
            "#ef4444",
            "#7c3aed",
            "#06b6d4",
            "#1f2937",
            "#22c55e",
            "#e11d48",
            "#0ea5e9"
        };

        var colors = new string[count];
        for (var i = 0; i < count; i++)
        {
            colors[i] = palette[i % palette.Length];
        }

        return colors;
    }
}
