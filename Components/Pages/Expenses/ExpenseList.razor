@page "/expenses"
@attribute [Authorize]
@inject IExpenseService ExpenseService
@inject ICategoryService CategoryService
@inject UserState UserState

<h3>My Expenses</h3>

<div class="filters">
    <DateRangePicker @bind-StartDate="startDate" @bind-EndDate="endDate" />
    <CategoryPicker @bind-SelectedCategoryId="selectedCategoryId" />
    <button @onclick="LoadExpenses">Filter</button>
</div>

<div class="actions">
    <a href="/expenses/create" class="btn btn-primary">Add Expense</a>
</div>

@if (isLoading)
{
    <LoadingSpinner />
}
else if (expenses == null || !expenses.Any())
{
    <p>No expenses found.</p>
}
else
{
    <div class="expense-grid">
        @foreach (var expense in expenses)
        {
            <ExpenseCard Expense="@expense" 
                        OnEdit="EditExpense"
                        OnDelete="DeleteExpense" />
        }
    </div>
}

@code {
    private List<Expense> expenses = new();
    private DateTime startDate = DateTime.Today.AddMonths(-1);
    private DateTime endDate = DateTime.Today;
    private int? selectedCategoryId;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadExpenses();
    }

    private async Task LoadExpenses()
    {
        isLoading = true;
        expenses = await ExpenseService.GetExpensesAsync(
            UserState.CurrentUserId,
            startDate,
            endDate,
            selectedCategoryId
        );
        isLoading = false;
    }

    private void EditExpense(int expenseId)
    {
        NavigationManager.NavigateTo($"/expenses/edit/{expenseId}");
    }

    private async Task DeleteExpense(int expenseId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "Are you sure you want to delete this expense?");
        
        if (confirmed)
        {
            await ExpenseService.DeleteExpenseAsync(expenseId);
            await LoadExpenses();
        }
    }
}